<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" >
	<head>
	    <title>Studio3</title>
		<meta name="viewport" content="width=device-width, user-scalable=0, maximum-scale=1"/>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="apple-touch-icon" href="icon.png" />
		<link rel="stylesheet" href="assets/debug.css" />
	</head>
<body style="margin:0;background: #333">
	<canvas id="canvas" width="480" height="320" style="cursor:pointer;display: block;outline:1px solid #BBFF00; image-rendering: -webkit-optimize-contrast;"></canvas>
</body>
<script src="studio-compiled.js"></script>
<script src="stats.js"></script>
<script>

var stage = new Studio.Stage('canvas',{webgl:0, dur:1000/60, fullscreen:0, color: Studio.BLUE, resolution: 2})


Studio.load = function(path, type, callback){
	
	var request = new XMLHttpRequest();

	request.onload = function() {
		var data = null;
		if ((request.status >= 200 && request.status < 400) || request.status == 0) {
			console.log('%cStudio loaded file : '+path, Studio.statStyle);
			
			if(type.toLowerCase() == "json"){
				data = JSON.parse(request.responseText);
			}
			if(callback){
				callback(data)
			}
		} else {
			this.onerror();
		}
	};

	request.onerror = function() {
		console.log('%cStudio failed to load file : '+path, Studio.errorStyle);
	};
	request.open('GET', path, true);
	request.send();
}

Studio.TileMap = function(data, set){
	this.cache = new Studio.Cache(30*32,16*32,1);
}

Studio.TileMap.prototype = {
	constructor: Studio.TileMap,
	build: function(data,set,sx,sy,mx,my){
		var map = data;
		var buffer = this.cache.ctx;
		var width = set.tileWidth;
		var height = set.tileHeight;
		var sx = sx || 0;
		var sy = sy || 0;
		var mX = mx || map.width-sx;
		var mY = my || map.height-sy;
		for(var y = 0; y !=mY; y++ ){
			for(var x = 0; x!= mX; x++){
				var i = (map.data[((y+sy)*map.width)+(x+sx)]) - set.firstgid;
				var _y = i/set.across | 0 ;
				var _x = i - (_y * set.across);
				buffer.drawImage(set.set.image, _x*set.tileWidth, _y*set.tileHeight, set.tileWidth, set.tileHeight, x*set.tileWidth, y*set.tileHeight, set.tileWidth, set.tileHeight)
			}
		}
		this.cache.ready = true;
	},
};



Studio.TileSet = function( image, width, height, imagewidth){
	this.firstgid = 1;
	this.tileWidth = width || 32;
	this.tileHeight = height || 32;
	this.across = imagewidth/width | 0;
	this.set = image || null;
}

Studio.TileSet.prototype = {
	constructor: Studio.TileSet,
	onLoadComplete: function(data){
		data.across = data.set.width/data.tileWidth;
	}
};

var map = new Studio.TileMap();

Studio.load('assets/thecurse.json','json', function(data){
	var set = data.tilesets[0];
	var setimage = new Studio.Image('assets/'+set.image);
	var tileset =  new Studio.TileSet( setimage, set.tilewidth, set.tileheight, set.imagewidth);
	var test = function test(result){
		if (!result) {
			console.log("The image isn't ready so we need to wait.");
			return;
		}
		if(result == true){
			// map  = new Studio.TileMap();
			console.log( 'The Image is ready, we can now create the tileset from the information provided, and then build the map from the data layer.' );
			for(var i in data.layers){
				map.build( data.layers[i], tileset);
			}
		}
	}
	// change to addListenerFunction( function ) ... this explains what the variable needs to be.
	setimage.status.addListener(test);
});
var tt = new Studio.Sprite({width: 960, height: 640, x: stage.width/2, y: stage.height/2, image: map.cache})
stage.addChild(tt);

var jane = new Studio.Image('assets/char.png');

var box = new Studio.Sprite({x:-100, y:-100, height: 42, width: 24, image: jane})
stage.addChild(box)
box.onEnterFrame = function(){
	if(stage.keys[38] || stage.keys["UP"]){
		this.y -= 4;
	}
	if(stage.keys[37] || stage.keys["LEFT"]){
		this.x -= 4;
	}
	if(stage.keys[40] || stage.keys["DOWN"]){
		this.y += 4;
	}
	if(stage.keys[39] || stage.keys["RIGHT"]){
		this.x += 4;
	}
	if(stage.keys["L1"]){
		stage.camera.scaleX = stage.camera.scaleY -= .01;
	}
	if(stage.keys["R1"]){
		stage.camera.scaleX = stage.camera.scaleY += .01;
	}
}

stage.enableKeyboardInput();

var GAMEPAD = new Studio.Plugin({
	options: {
	},
	init: function(a) {
		this.gamepads = navigator.getGamepads();
		this.gamepad = null;
	    this.remote = null;
	},
	action: function(a) {
		this.gamepads = navigator.getGamepads();
		this.gamepad = null;
	    this.remote = null;

	    for(var z = 0; z!=this.gamepads.length;z++){
	        if(this.gamepads[z]){
	        	if(this.gamepads[z].id=='Remote'){
	            	this.remote = this.gamepads[z]
	            }else{
	            	this.gamepad = this.gamepads[z]
	            }
	        }
	    }
	    for(var i = 0; i != this.gamepads.length; i ++){
	        if(this.gamepads[i]){
	            this.gamepad = this.gamepads[i];
	            stage.keys['A'] = this.gamepad.buttons[0].value; // A
	            stage.keys['B'] = this.gamepad.buttons[1].value; // B
	            stage.keys['X'] = this.gamepad.buttons[2].value; // X
	            stage.keys['Y'] = this.gamepad.buttons[3].value; // Y

	            stage.keys['L1'] = this.gamepad.buttons[4].value; // L1
	            stage.keys['R1'] = this.gamepad.buttons[5].value; // R1
	            stage.keys['L2'] = this.gamepad.buttons[6].value; // L2
	            stage.keys['R2'] = this.gamepad.buttons[7].value; // R2

	            stage.keys['UP'] = this.gamepad.buttons[12].value; // Up
	            stage.keys['DOWN'] = this.gamepad.buttons[13].value; // Down
	            stage.keys['LEFT'] = this.gamepad.buttons[14].value; // Left
	            stage.keys['RIGHT'] = this.gamepad.buttons[15].value; // Right

	            //stage.keys['MENU'] = this.gamepad.buttons[16].value; // Menu

	            // drawAnalogStick(gamepad.axes[0], gamepad.axes[1], 540, 416); // left stick
	            // drawAnalogStick(gamepad.axes[2], gamepad.axes[3], 736, 416); // right stick
	            // ctx.translate(1200,0)
	        }
	    }
	}
})

if(navigator.getGamepads){
	stage.addEffect(GAMEPAD);
}

stage.camera.bindTo(tt)
stage.camera.track(box)
stage.addEffect(STATS,{
	external: true, 
	height: 50,
	width: stage.width,
	position: 0,
	clear_mode:'cover'}
);
Studio.start();

</script>
</html>