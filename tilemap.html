<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" >
	<head>
	    <title>Studio3</title>
		<meta name="viewport" content="width=device-width, user-scalable=0, maximum-scale=1"/>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="apple-touch-icon" href="icon.png" />
		<link rel="stylesheet" href="assets/debug.css" />
	</head>
<body style="margin:0;background: #333">
	<canvas id="canvas" width="960" height="640" style="cursor:pointer;display: block;outline:1px solid #BBFF00;"></canvas>
</body>
<script src="studio-compiled.js"></script>
<script>

var stage = new Studio.Stage('canvas',{webgl:0, dur:1000/30, fullscreen:0, color: Studio.BLUE})

function getImage(url){
    return new Promise(function(resolve, reject){
        var img = new Image()
        img.onload = function(){
            resolve(url)
        }
        img.onerror = function(){
            reject(url)
        }
        img.src = url
    })
}


Studio.FocusEngine = function(){
	this.active = null;
	this.focus_list = new LinkedList();
}


Studio.load = function(path, type, callback){
	
	var request = new XMLHttpRequest();

	request.onload = function() {
		var data = null;
		if ((request.status >= 200 && request.status < 400) || request.status == 0) {
			console.log('%cStudio loaded file : '+path, Studio.statStyle);
			
			if(type.toLowerCase() == "json"){
				data = JSON.parse(request.responseText);
			}
			if(callback){
				callback(data)
			}
		} else {
			this.onerror();
		}
	};

	request.onerror = function() {
		console.log('%cStudio failed to load file : '+path, Studio.errorStyle);
	};
	request.open('GET', path, true);
	request.send();
}

Studio.TileMap = function(data, set){
	this.cache = new Studio.Cache(480,320,1);
}

Studio.TileMap.prototype = {
	constructor: Studio.TileMap,
	build: function(data,set,sx,sy,mx,my){
		var map = data;
		var buffer = this.cache.buffer;
		var width = set.tileWidth;
		var height = set.tileHeight;
		var sx = sx || 0;
		var sy = sy || 0;
		var mX = mx || map.width-sx;
		var mY = my || map.height-sy;
		for(var y = 0; y !=mY; y++ ){
			for(var x = 0; x!= mX; x++){
				var i = (map.data[((y+sy)*map.width)+(x+sx)]) - set.firstgid;
				var _y = i/set.across | 0 ;
				var _x = i - (_y * set.across);
				buffer.drawImage(set.set.image, _x*set.tileWidth, _y*set.tileHeight, set.tileWidth, set.tileHeight, x*set.tileWidth, y*set.tileHeight, set.tileWidth, set.tileHeight)
			}
		}
		this.cache.ready = true;
	},
};



Studio.TileSet = function( image, width, height, imagewidth){
	this.firstgid = 1;
	this.tileWidth = width || 32;
	this.tileHeight = height || 32;
	this.across = imagewidth/width | 0;
	this.set = image || null;
}

Studio.TileSet.prototype = {
	constructor: Studio.TileSet,
	onLoadComplete: function(data){
		data.across = data.set.width/data.tileWidth;
	}
};

var map = new Studio.TileMap();

Studio.load('assets/simplemap.json','json', function(data){
	var set = data.tilesets[0];
	var setimage = new Studio.Image('assets/'+set.image);
	var tileset =  new Studio.TileSet( setimage, set.tilewidth, set.tileheight, set.imagewidth);
	var test = function(result){
		if (!result) {
			console.log("The image isn't ready so we need to wait.");
			return;
		}
		if(result == true){
			// map  = new Studio.TileMap();
			console.log( 'The Image is ready, we can now create the tileset from the information provided, and then build the map from the data layer.' );
			for(var i in data.layers){
				map.build( data.layers[i], tileset);
			}
		}
	}
	// change to addListenerFunction( function ) ... this explains what the variable needs to be.
	setimage.status.addListener(test);
});
var tt = new Studio.Sprite({width: 960, height: 640, x: stage.width/2, y: stage.height/2, image: map.cache})
stage.addChild(tt);
Studio.start();

</script>
</html>