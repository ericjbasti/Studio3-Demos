<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" >
    <title>Studio3</title>
	<meta name="viewport" content="width=device-width, user-scalable=0, maximum-scale=1"/>
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<link rel="apple-touch-icon" href="icon.png" />
</head>

<body style="margin:0;background: #333">
	<canvas id="canvas" height="360" width="640"  style="cursor:pointer;margin: 0 auto;display: block;outline:1px solid #BBFF00;"></canvas>
</body>
<script src="studio-compiled.js"></script>
<script src="stats.js"></script>
<style>
	canvas{image-rendering: -webkit-optimize-contrast;}

</style>
<script>
	
var stage = new Studio.Stage("canvas",{fullscreen:2, resolution: 1, dur: 1000/60, interpolate: 0});
	    stage.GAMEPAD_1 = {};
	    stage.GAMEPAD_2 = {};
Studio.UIButton = function(attr, stage){
	this.hovered = false;
	this.text = 'Button';
	if (attr) {
		this.apply(attr);
	}
	this.back = new Studio.Rect({height: this.height, width: this.width});
	this.back.color.setFromHex("#FF00FF")
	this.front = new Studio.Rect({height: this.height-4, width: this.width-4});
	this.front.color.set(0,0,0,.8);
	this.textBox = new Studio.TextBox(this.width-10, this.height, stage).apply({
		x: 0 , 
		y: 0 , 
		font: '16px BigBreak',
		lineHeight: 14 | 0 , 
		vertical_align: Studio.MIDDLE, 
		horizontal_align: 0.5,
		shadowColor: '#FF0080'
	})
	this.front.color.set(0,0,0,.8);
	this.textBox.setText(this.text).finish();
	this.addChildren(this.back,this.front,this.textBox);
	this.hoverIn_tween = stage.createTween(this, 'quadInOut', {scaleX: 1.2, scaleY: 1.2, rotation: 10}, 300).loop().reflect(true);
	this.hoverOut_tween = stage.createTween(this, 'quadOut', {scaleX: 1, scaleY: 1, rotation: 0}, 300);
}
Studio.UIButton.prototype = new Studio.DisplayObject();
Studio.UIButton.prototype.constructor = Studio.UIButton;

Studio.UIButton.prototype.onTap = Studio.UIButton.prototype.onHoverStart = function(a){
	if(this.hover){
		this.hover(a);
	}
}
Studio.UIButton.prototype.onTapOutside = Studio.UIButton.prototype.onHoverEnd = function(a){
	if(this.reset){
		this.reset(a);
	}
}

Studio.UIButton.prototype.onRelease = function(a){
	if(this.action){
		this.action(a);
	}
	if(this.reset){
		this.reset(a);
	}
}

var button = new Studio.UIButton({x:400,y:150, height: 24, width: 60, text:'Jump!'},stage);
button.hover = function(a){
	stage.stopTween(this.hoverOut_tween)
	stage.playTween(this.hoverIn_tween)
	this.back.color.setFromHex("#FF0080")
	this.textBox.setColor('#FFFF66').finish()
}
button.reset = function(a){
	stage.stopTween(this.hoverIn_tween);
	stage.playTween(this.hoverOut_tween)
	this.back.color.setFromHex("#FF00FF")
	this.textBox.setColor('#FFFFFF').finish()
}

button.action = function(a){
	t.velocityY = -20;
}

var buttonRight = new Studio.UIButton({x:450,y:200, height: 24, width: 24, text:'>'},stage);

buttonRight.hover = function(a){
	t.velocityX +=30;
}
var buttonLeft = new Studio.UIButton({x:410,y:200, height: 24, width: 24, text:'<'},stage);

buttonLeft.hover = function(a){
	t.velocityX -=30;
}
var button2 = new Studio.UIButton({x: 200, y: 100, height: 80, width: 300, text:"Hello Chupe...\n\nWelcome to a world of shapes. Those RED block? Oh you can stand on those if you want."}, stage)





var curse = new Studio.SpriteSheet('assets/Seperated.png')
var ball_img = new Studio.Image('assets/ball3.png');
var chupe = new Studio.SpriteSheet('assets/chupe.png');
var right = {
	pant: [[0,1],[1,1],[2,1],[3,1]],
	walk: [[0,0],[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0]],
	jump: [[6,1],[6,1]]
}

var left = {
	pant: [[0,3],[1,3],[2,3],[3,3]],
	walk: [[0,2],[1,2],[2,2],[3,2],[4,2],[5,2],[6,2],[7,2]],
	jump: [[5,3],[5,3]]
}

var makePhysicObject = function(who, world){
	who.velocityY = 0;
	who.velocityX = 0;
	who.friction  = .9;
	who.bounce = 0;
	if(!who.hitbox){ // if we don't have a unique hitbox, we'll use our own rect as a hitbox
		who.hitbox = who;
	}
	who.maxVelocity = who.height/2;
	who.logic = function(){
		// gravity is a constant force
		this.velocityY += world.gravity;

		if(this.platform && ! this.jumping){
			if(this.platform.velocityX)	this.x+=this.platform.velocityX;
			if(this.platform.velocityY)	this.y+=this.platform.velocityY;
		}
		if(this.velocityY>this.maxVelocity) this.velocityY = this.maxVelocity;
		this.velocityX *= this.friction;
		this.y+=this.velocityY;
		this.x+=this.velocityX;
		if(this.y+this._world.height*this.anchorY>world.height){
			this.y = world.height-(this._world.height*this.anchorX);
			this.velocityY *= this.bounce;
			this.jumping = false;
			this.platform = false;
		}
		if(this.x>world.width){
			this.x-=world.width;
		}
		if(this.x<0){
			this.x+=world.width;
		}
	}
}


var Player = function(world){
	this.width = 32;
	this.height= 32; 
	this.sheet= chupe;
	this.rect ={x:0,y:0, width: 32, height: 32};
	this.loop = right.walk;
	this.hitbox = new Studio.DisplayObject({height: 32, width: 20});
	this.addChild(this.hitbox);
	this.score = 0;
	makePhysicObject(this,world);
	this.borderlap = true;
	this.border= world;
	this.jumping = false;
	this.dir = right;
	this._hitAnimation = world.createTween(this,'bounceOut',{scaleY:.5, scaleX: 1.5}, 150);
	this._hitAnimation.then('linear',{},200).then('elasticOut',{scaleY:1, scaleX:1}, 600, function(){this._hit=0}).last();
}
Studio.extend(Player,Studio.SpriteAnimation)

Player.prototype.hit = function(){
	stage.playTween(this._hitAnimation);
}

var PLAYER_1 = new Player(stage);
PLAYER_1.x =20
var PLAYER_2 = new Player(stage);
PLAYER_2.x=300
PLAYER_2.offsetY= 4
stage.gravity = .78;




// RECT overlapdraw
// t.draw = function(ctx){
// 	this.setStyle(ctx);
// 	this.setAlpha(ctx);
// 	ctx.drawImage(this.image.image, this.rect.x, this.rect.y, this.rect.width, this.rect.height, this._dx - (this._world.width*this.anchorX), this._dy - (this._world.height*this.anchorY), this._world.width, this._world.height)
// 	if(this._dx -  (this._world.width*this.anchorX) < 0){
// 		ctx.drawImage(this.image.image, this.rect.x, this.rect.y, this.rect.width, this.rect.height, stage.width + this._dx - (this._world.width*this.anchorX), this._dy - (this._world.height*this.anchorY), this._world.width, this._world.height);
// 		return;
// 	}
// 	if((this._dx + this._world.width) > stage.width){
// 		ctx.drawImage(this.image.image, this.rect.x, this.rect.y, this.rect.width, this.rect.height, this._dx - (this._world.width*this.anchorX) -stage.width, this._dy - (this._world.height*this.anchorY), this._world.width, this._world.height);
// 		return; 
// 	}
// }



var blocks = [];

for (var i = 0; i != 2; i++){
	var block = new Studio.ImageSlice({x: 16+(i*32), y: 32*7, height: 32, width: 32, image:curse, rect:{x:0,y:32*12, width:32, height:32}})
	blocks.push(block);
	stage.addChild(block);
}

for (var i = 0; i != 22; i++){
	var block = new Studio.ImageSlice({x: 0+(i*32), y: 32*11, height: 32, width: 32, image:curse, rect:{x:0,y:32*12, width:32, height:32}})
	blocks.push(block);
	stage.addChild(block);
}


for (var i = 0; i != 2; i++){
	var block = new Studio.ImageSlice({x: (stage.width-16)-(i*32), y: 32*7, height: 32, width: 32, image:curse, rect:{x:0,y:32*12, width:32, height:32}})
	blocks.push(block);
	stage.addChild(block);
}
for (var i = 0; i != 6; i++){
	var block = new Studio.ImageSlice({x: (stage.width/2)-(i*32)+62, y: 32*10, height: 32, width: 32, image:curse, rect:{x:0,y:32*12, width:32, height:32}})
	blocks.push(block);
	stage.addChild(block);
}
for (var i = 0; i != 4; i++){
	var block = new Studio.ImageSlice({x: (stage.width/2)-(i*32)+32, y: 32*9, height: 32, width: 32, image:curse, rect:{x:0,y:32*12, width:32, height:32}})
	blocks.push(block);
	stage.addChild(block);
}
for (var i = 0; i != 2; i++){
	var block = new Studio.ImageSlice({x: (stage.width/2)-(i*32), y: 32*8, height: 32, width: 32, image:curse, rect:{x:0,y:32*12, width:32, height:32}})
	blocks.push(block);
	stage.addChild(block);
}

var movers = new Studio.DisplayObject();
movers.x = (stage.width/2)-32
movers.y = 32*5;
var count = 0;
movers.onEnterFrame = function(){
	this.velocityX = Math.sin(count)*2;
	this.velocityY = Math.cos(count);
	this.x += this.velocityX;
	this.y += this.velocityY;
	count+=.02;
	for(var i = 0; i!= this.hasChildren; i++){
		this.children[i].velocityX = this.velocityX;
	}
}
for (var i = 0; i != 2; i++){
	var block = new Studio.ImageSlice({x: (i*32), y: 0, height: 32, width: 32, image:curse, rect:{x:0,y:32*13, width:32, height:32}})
	blocks.push(block);
	movers.addChild(block);
}
stage.addChild(movers)


var prizes = [];
var prizemax = 7;
var prizegot = 0;
for (var i = 0; i != prizemax; i++){
	var block = new Studio.ImageSlice({x: 100+(i*60), y: 64+parseInt(Math.random()*5)*32, height: 20, width: 20, image:curse, rect:{x:0,y:32*6, width:32, height:32}})
	prizes.push(block);
	stage.addChild(block);
}


stage.gamepadInput = function(t, pad){
	if((this.keys[38] || pad["UP"] || pad["A"])){
		if(!t.jumping){
			t.velocityY = -16;
			t.jumping = true;
		}
	}
	if(this.keys[37] || pad["LEFT"]){
		t.velocityX -= .51;
		t.dir = left;
	}
	if(this.keys[32] || pad["B"]){
		if(!ball.jumping){
			ball.y=t.y;
			ball.x = t.x;
			ball.velocityY = 0;
			ball.jumping = true;
			if(t.dir==left){
				ball.velocityX=-16;
			}else{
				ball.velocityX=16;
			}
		}
	}
	if(this.keys[40] || pad["DOWN"]){
		//t.velocityY += 4;
	}
	if(this.keys[39] || pad["RIGHT"]){
		t.velocityX += .51;
		t.dir = right;
	}
	if (t.velocityY < 0){
		t.loop = t.dir.jump;
	}else{
		if (t.velocityX > 1 || t.velocityX < -1){
			t.loop = t.dir.walk;
			t.fps = 12;
		}else{
			t.loop = t.dir.pant;
			t.fps = 6
		}
	}
}

var ball = new Studio.Sprite({image:ball_img, x:200,y:200, height: 11, width: 11, color: Studio.BLUE})
makePhysicObject(ball,stage)
ball.velocityX = 12
ball.friction = .95
ball.maxVelocity = 10;
ball.bounce = -.25
stage.addChild(ball)

var player_1_score = new Studio.TextBox(128,32,stage);
player_1_score.x = 90;
player_1_score.y = 32
player_1_score.setText('Player 1: 0').finish();
stage.addChild(player_1_score);
var player_2_score = new Studio.TextBox(128,32,stage);
player_2_score.x = stage.width-90;
player_2_score.y = 32
player_2_score.setText('Player 2: 0').finish();
stage.addChild(player_2_score);


var actionables = [PLAYER_1,PLAYER_2,ball];

stage.logic = function(){

	if(PLAYER_1){
		this.gamepadInput(PLAYER_1, stage.GAMEPAD_1);
	}
	if(PLAYER_2){
		this.gamepadInput(PLAYER_2, stage.GAMEPAD_2);
	}

	// PLAYER_1.velocityX=3


	if(!PLAYER_1._hit && !PLAYER_2._hit){
		if(PLAYER_1.hitbox.hitTestRect(PLAYER_2.hitbox)){
			var dx = PLAYER_1.x-PLAYER_2.x;
			var dy = PLAYER_1.y-PLAYER_2.y;
			if(PLAYER_2.velocityY>10){
				PLAYER_1._hit = true;
				PLAYER_1.hit();
				PLAYER_2.velocityY = -18;
				PLAYER_2.jumping = true;
			}
			if(PLAYER_1.velocityY>10){
				PLAYER_2._hit = true;
				PLAYER_2.hit();
				PLAYER_1.velocityY = -18;
				PLAYER_1.jumping = true;
			}
		}
	}

	for (var i = 0; i != blocks.length; i++){
		var block = blocks[i];
		for(var j = 0; j!=actionables.length; j++){
			var t = actionables[j];
			if(block._world.x-32>t.x || block._world.x+32<t.x){

			}else if(block._world.y-32>t.y || block._world.y+32<t.y){

			}else if(t.hitbox.hitTestRect(block)){



				var dx = t.x-block._world.x;
				var dy = t.y-block._world.y;
				t.platform = block;
				if(dy<-10 && t.velocityY>0){
					if(t.y+(t.height*t.anchorY) < block._world.y){
						t.velocityY *= t.bounce;
						t.y = block._world.y-(block._world.height*block.anchorY)-(t._world.height*t.anchorY)-1;
						t._snapback();
						t.jumping = false;
					}
					// return;
				}
			}else{

			}
		}
	}

	for (var i = 0; i != prizes.length; i++){
		var block = prizes[i];
		for(var j = 0; j!=actionables.length; j++){
			var t = actionables[j];
			if(block.got){

			}else if(block.x-32>t.x || block.x+32<t.x){
				
			}else if(block.y-32>t.y || block.y+32<t.y){

			}else if(t.hitbox.hitTestRect(block)){
				block.got = true;
				if(t==PLAYER_1){
					PLAYER_1.score++;
					player_1_score.setText('Player 1: '+PLAYER_1.score).finish();
				}
				if(t==PLAYER_2){
					PLAYER_2.score++;
					player_2_score.setText('Player 2: '+PLAYER_2.score).finish();
				}
				prizegot++;
				stage.addTween(block,'quadOut', {scaleX: 2, scaleY: 2 , alpha: 0, rotation: 360}, 300 , function(){
					if(prizegot ==prizemax){
						for(var i = 0; i != prizes.length; i++){
							var block = prizes[i];
							block.y= 64+parseInt(Math.random()*5)*32;
							stage.addTween(block,'quadIn', {scaleX: 1, scaleY: 1 , alpha: 1, rotation: 0}, 300, function(){
								this.got = false;
							});
							prizegot = 0;
						}
					}
				});
			}else{
				// t.alpha = 1;
			}
		}
	}


}

// stage.enableTouchEvents();

// stage.addButton(button);
// stage.addButton(buttonRight);
// stage.addButton(buttonLeft);
stage.addChild(PLAYER_1)

stage.addChild(PLAYER_2)
// stage.addChildren(button, buttonRight, buttonLeft);

// stage.addChild(button2)

// stage.addEffect(Studio.Effect.Bloom);
// stage.addEffect(Studio.Effect.BillAtkinsonDither_BW);
// stage.addEffect(STATS,{
// 	external: false, 
// 	height: 60,
// 	width: stage.width,
// 	position: 0,
// 	clear_mode:'cover'}
// );

stage.enableKeyboardInput();

var GAMEPAD = new Studio.Plugin({
	options: {
	},
	init: function(a) {
		this.gamepads = navigator.getGamepads();
		this.gamepad = null;
		this.active = true;
	},
	action: function(stage) {
		this.gamepads = navigator.getGamepads();
		var pad = null;
	    for(var i = 0; i != this.gamepads.length; i ++){
	        if(this.gamepads[i]){
	            this.gamepad = this.gamepads[i];

	            if(i==0){
	            	pad = stage.GAMEPAD_1;
	            }else if(i==1){
	            	pad = stage.GAMEPAD_2;
	            }

	            pad['A'] = this.gamepad.buttons[0].value; // A
	            pad['B'] = this.gamepad.buttons[1].value; // B
	            pad['X'] = this.gamepad.buttons[2].value; // X
	            pad['Y'] = this.gamepad.buttons[3].value; // Y

	            pad['L1'] = this.gamepad.buttons[4].value; // L1
	            pad['R1'] = this.gamepad.buttons[5].value; // R1
	            pad['L2'] = this.gamepad.buttons[6].value; // L2
	            pad['R2'] = this.gamepad.buttons[7].value; // R2

	            pad['UP'] = this.gamepad.buttons[12].value; // Up
	            pad['DOWN'] = this.gamepad.buttons[13].value; // Down
	            pad['LEFT'] = this.gamepad.buttons[14].value; // Left
	            pad['RIGHT'] = this.gamepad.buttons[15].value; // Right

	            //stage.keys['MENU'] = this.gamepad.buttons[16].value; // Menu

	            // drawAnalogStick(gamepad.axes[0], gamepad.axes[1], 540, 416); // left stick
	            // drawAnalogStick(gamepad.axes[2], gamepad.axes[3], 736, 416); // right stick
	            // ctx.translate(1200,0)
	        }
	    }
	}
})

if(navigator.getGamepads){
	stage.addInput(GAMEPAD);
}


stage.snap=true
stage.ready = true;
Studio.start();
</script>
</html>

