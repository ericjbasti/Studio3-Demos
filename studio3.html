<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" >
    <title>Studio3</title>
	<meta name="viewport" content="width=device-width, user-scalable=0, maximum-scale=1"/>
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<link rel="apple-touch-icon" href="icon.png" />
</head>

<body style="margin:0;background: #333">
	<canvas id="canvas" height="380" width="512"  style="cursor:pointer;margin: 0 auto;display: block;outline:1px solid #BBFF00;"></canvas>
</body>
<script src="studio-compiled.js"></script>
<script src="stats.js"></script>
<script>
	
var stage = new Studio.Stage('canvas',{webgl:0, dur:1000/60, fullscreen:1, resolution: 1})
stage.color.setFromHex("#333")
var butter_sheet = new Studio.Image('assets/butterfly.png');

var BlueMorpho = function(attr){
	this.image = butter_sheet;
	this.width = 22;
	this.height = 85;
	this.y = 200
	this.rect = {x:250, y:0, height: 85, width: 22};
	this.scaleY = this.scaleX = .5 + (Math.random()*.15)
	if(attr){
		this.apply(attr);
	}
	this.leftWing = new Studio.ImageSlice({rect:{x:0, y:0, height: 194, width: 122}, image: butter_sheet, anchorX: 1, height: 194, width: 122, x: -5, y: -15});
	this.rightWing = new Studio.ImageSlice({rect:{x:122, y:0, height: 194, width: 122}, image: butter_sheet, anchorX: 0, height: 194, width: 122, x:5, y: -15});
	this.addChild(this.leftWing)
	this.addChild(this.rightWing)
	this.init();
}
Studio.extend(BlueMorpho, Studio.ImageSlice)

BlueMorpho.prototype.init = function(){
	this.count = Math.random()*22;
	this.speed = .7+ Math.random()
}

BlueMorpho.prototype.boundsCheck = function(){
	if(this.x< -100){
		this.x = stage.width+100;
		this.rotation = 0;
	}
	if(this.y< -100){
		this.y = stage.height+100;
		this.speed = .7+ Math.random()
		this.rotation = 0;
	}
}
BlueMorpho.prototype.onEnterFrame = function(){
	var a = Math.cos(this.count);
	this.leftWing.scaleX = .66 - (a * .65);
	this.rightWing.scaleX = .66 - (a * .65);
	this.leftWing.scaleY = 1 + (a * .1);
	this.rightWing.scaleY = 1 + (a * .1);
	this.count+= .3 * this._world.speed;
	this.rotation += a;
	this.x += .5 -Math.random() * 2 * this._world.speed;
	this.y += .5 -Math.random() * 2 * this._world.speed;
	
	this.boundsCheck();
}


var Monarch = function(attr){
	this.image = butter_sheet;
	this.width = 18;
	this.height = 66;
	this.y = 200
	this.rect = {x:250, y:0, height: 85, width: 22};
	this.scaleY = this.scaleX = .4 + (Math.random()*.15)
	if(attr){
		this.apply(attr);
	}
	this.leftWing = new Studio.ImageSlice({rect:{x:246, y:96, height: 159, width: 114}, image: butter_sheet, anchorX: 1, height: 194, width: 122, x: -3, y: -15});
	this.rightWing = new Studio.ImageSlice({rect:{x:246+114, y:96, height: 159, width: 114}, image: butter_sheet, anchorX: 0, height: 194, width: 122, x:3, y: -15});
	this.addChild(this.leftWing)
	this.addChild(this.rightWing)
	this.init();
}

Studio.extend(Monarch, Studio.ImageSlice)

Monarch.prototype.init = function(){
	this.count = Math.random()*22;
	this.speed = .7+ Math.random()
}

Monarch.prototype.boundsCheck = function(){
	if(this.x< -100){
		this.x = stage.width+100;
		this.rotation = 0;
	}
	if(this.y< -100){
		this.y = stage.height+100;
		this.speed = .7+ Math.random()
		this.rotation = 0;
	}
}
Monarch.prototype.onEnterFrame = function(){
	var a = Math.cos(this.count);
	this.leftWing.scaleX = .66 - (a * .65);
	this.rightWing.scaleX = .66 - (a * .65);
	this.leftWing.scaleY = 1 + (a * .1);
	this.rightWing.scaleY = 1 + (a * .1);
	this.count+= .3 * this._world.speed;
	this.rotation += a;
	this.x += .5 -Math.random() * 2 * this._world.speed;
	this.y += .5 -Math.random() * 2 * this._world.speed;
	
	this.boundsCheck();
}

for (var i = 0; i != 30 ; i++){
	var a = new BlueMorpho({x: Math.random() * stage.width, y: Math.random() * stage.height});
	stage.addChild(a);
	// stage.addChild(b);
}
for (var i = 0; i != 55 ; i++){
	var b = new Monarch({x: Math.random() * stage.width, y: Math.random() * stage.height});
	stage.addChild(b);
}

var BillAtkinsonDither_BW = new Studio.Plugin({
	options: {

	},
	init: function(a) { // lets build out a canvas for the stats
		// this.cache = new Studio.Cache(a.width,a.height,a.resolution);

		this.oldpixel = 1;
		this.newpixel = 1;
		this.qerror = 1;
	},
	action: function(a) {
		var pixels = a.ctx.getImageData(0,0,a.canvas.width,a.canvas.height);
		var pixeldata = pixels.data;
		var width = parseInt(a.canvas.width*4)
		var length = pixeldata.length;

		for (var i=0; i < length; i+=4) {
			this.oldpixel = pixeldata[i];

			this.newpixel = this.oldpixel >> 7;
			this.newpixel *= 255;

			pixeldata[i] = pixeldata[i+1] = pixeldata[i+2] = this.newpixel;

			this.qerror = (this.oldpixel - this.newpixel) * .15;

			if((i % width === 0) && (i+4 % width === 0) && (i+8 % width === 0)){

			}else{
				pixeldata[i+5] = pixeldata[i+6] = pixeldata[i+4]+= this.qerror;
				pixeldata[i+9] = pixeldata[i+10] = pixeldata[i+8]+= this.qerror;
				pixeldata[i+5+width] = pixeldata[i+6+width] = pixeldata[i+4+width] += this.qerror;
				pixeldata[i+1+width] = pixeldata[i+2+width] = pixeldata[i+width] += this.qerror;
				pixeldata[i+width-3] = pixeldata[i+width-2] = pixeldata[i+width-4] += this.qerror;
				pixeldata[i+width*2] = pixeldata[i+(width*2)] = pixeldata[i+(width*2)] += this.qerror;
			}
		}
		a.ctx.putImageData(pixels,0,0);
	}
})

var OldTV = new Studio.Plugin({
	options: {

	},
	init: function(a) { // lets build out a canvas for the stats
		// this.cache = new Studio.Cache(a.width,a.height,a.resolution);
		this.oldpixel = 1;
		this.newpixel = 1;
		this.qerror = 1;
	},
	action: function(a) {
		var pixels = a.ctx.getImageData(0,0,a.canvas.width,a.canvas.height);
		var pixeldata = pixels.data;
		var width = a.canvas.width*4;
		var length = pixeldata.length;

		for (var i=0; i < length; i++) {
			this.oldpixel = pixeldata[i];

			this.newpixel = this.oldpixel >> 7;
			this.newpixel *= 255;

			pixeldata[i] = this.newpixel;

			this.qerror = (this.oldpixel - this.newpixel) * .25;

			if((i % width === 0) && (i+4 % width === 0) && (i+8 % width === 0)){

			}else{
				pixeldata[i+4]+= this.qerror;
				pixeldata[i+8]+= this.qerror;
				pixeldata[i+width] += this.qerror;
			}
		}
		a.ctx.putImageData(pixels,0,0);
	}
})


var Posterize = new Studio.Plugin({
	options: {

	},
	init: function(a) { // lets build out a canvas for the stats
		// this.cache = new Studio.Cache(a.width,a.height,a.resolution);
		this.oldpixel = 1;
		this.newpixel = 1;
		this.qerror = 1;
	},
	action: function(a) {
		var pixels = a.ctx.getImageData(0,0,a.canvas.width,a.canvas.height);
		var pixeldata = pixels.data;
		var width = a.canvas.width*4;
		var length = pixeldata.length;

		for (var i=0; i < length; i++) {
			this.oldpixel = pixeldata[i];

			this.newpixel = this.oldpixel >> 7;
			this.newpixel *= 255;

			pixeldata[i] = this.newpixel;


		}
		a.ctx.putImageData(pixels,0,0);
	}
})


var Replicator = new Studio.Plugin({
	options: {
		x: 3,
		y: 3,
	},
	init: function(a) {
		this.cache = new Studio.Cache();
	},
	action: function(a) {
		var width = a.canvas.width/this.options.x;
		var height = a.canvas.height/this.options.y;
		this.cache.image.width = width;
		this.cache.image.height = height;
		this.cache.buffer.drawImage(a.canvas,0,0, width, height);
		for(var i = 0; i!= this.options.x; i++){
			for(var j = 0; j!= this.options.y; j++){
				a.ctx.drawImage(this.cache.image, i * width , j * height, width ,height)
			}
		}
	}
})

var Bloom = new Studio.Plugin({
	options: {
	},
	init: function(a) {
		this.height = (a.canvas.height/2)*a.resolution;
		this.width = (a.canvas.width/2)*a.resolution;
		this.cache = new Studio.Cache(this.width,this.height);
		// this.cache.buffer.strokeStyle = '#fff';
		// this.cache.buffer.strokeRect( 10, 10, this.width-20, this.height-20);
		// this.cache.buffer.strokeRect( 15, 15, this.width-30, this.height-30);
		// this.cache.buffer.fillStyle = "rgba(200,0,0,.5)";
		// this.cache.buffer.fillRect( 25, this.height-25-this.height/4, this.width/4, this.height/4);
		this.cache.buffer.globalAlpha = .25
	},
	action: function(a) {
		this.cache.buffer.globalCompositeOperation = "source-over"
		this.cache.buffer.fillStyle="rgba(0,0,0,.15)";
		this.cache.buffer.fillRect( 0,0,this.width, this.height);
		this.cache.buffer.globalCompositeOperation = "lighten"
		this.cache.buffer.drawImage(a.canvas,0,0, this.width, this.height)
		a.ctx.globalCompositeOperation = 'lighten';
		a.ctx.drawImage(this.cache.image, 0, 0, a.canvas.width, a.canvas.height)
		a.ctx.globalCompositeOperation = 'source-over';
	}
})

var Cursor = new Studio.Plugin({
	options: {
	},
	init: function(a) {
		this.cursor = new Studio.Image('assets/cursor.png');
		a.canvas.style.cursor = 'none';
	},
	action: function(a) {
		a.ctx.drawImage(this.cursor.image, a.mouse.x-8, a.mouse.y-8, 48, 48)
	}
})


var Red = new Studio.Plugin({
	options: {
	},
	init: function(a) {
		
	},
	action: function(a) {
		var myGetImageData = a.ctx.getImageData(0,0,a.canvas.width, a.canvas.height);
		var buffer = myGetImageData.data.buffer;
		var sourceBuffer8 = new Uint8Array(buffer);
		var sourceBuffer32 = new Uint32Array(buffer);
		var length = sourceBuffer32.length;
		for (var i = 0 ; i!=length; i++){
			var temp = myGetImageData.data[i*4+1];
			sourceBuffer32[i]= (255 << 24) |
                (255-temp << 16) | 
                (temp <<  8) |
                 255-temp
		}
		myGetImageData.data.set(sourceBuffer8);
		a.ctx.putImageData(myGetImageData, 0, 0);
	}
})


// stage.addEffect(Red);


// stage.addEffect(Cursor);
// stage.addEffect(Bloom);
// stage.addEffect(Replicator,{x:3,y:3});
stage.addEffect(STATS,{
	external: false, 
	height: 50,
	width: stage.width,
	position: 0,
	clear_mode:'cover'}
);
// stage.addEffect(Replicator);
// stage.enableTouchEvents();
Studio.start();

</script>


</html>

